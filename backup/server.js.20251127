#!/usr/bin/env node

const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');

// -------------------------
// ì˜µì…˜ íŒŒì‹±
// -------------------------
const args = process.argv.slice(2);
const pIndex = args.indexOf('-p');
const hIndex = args.indexOf('-h');
const fIndex = args.indexOf('-f');

const port = pIndex !== -1 ? parseInt(args[pIndex + 1]) : 80;
const host = hIndex !== -1 ? args[hIndex + 1] : 'localhost';
const defaultDir = fIndex !== -1 ? args[fIndex + 1] : null;

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// chunk ì €ì¥ ìœ„ì¹˜
const CHUNK_TEMP_DIR = "chunk_temp";
if (!fs.existsSync(CHUNK_TEMP_DIR)) fs.mkdirSync(CHUNK_TEMP_DIR);

// multer
const upload = multer({ dest: CHUNK_TEMP_DIR });

// í´ë” ìƒì„±
function ensureDir(dirPath) {
    if (!fs.existsSync(dirPath)) {
        fs.mkdirSync(dirPath, { recursive: true });
    }
}

// -------------------------
// 1) CHUNK ì—…ë¡œë“œ
// -------------------------
app.post('/upload-chunk', upload.single('chunk'), (req, res) => {
    const { uploadId, index } = req.body;

    if (!uploadId || index === undefined) {
        return res.status(400).send("Missing uploadId or index");
    }

    const chunkDir = path.join(CHUNK_TEMP_DIR, uploadId);
    ensureDir(chunkDir);

    const destPath = path.join(chunkDir, `${index}.chunk`);

    fs.renameSync(req.file.path, destPath);

    res.status(200).send("CHUNK_OK");
});

// -------------------------
// 2) CHUNK ì™„ë£Œ ì•Œë¦¼ â†’ ì„œë²„ì—ì„œ íŒŒì¼ ì¡°ë¦½
// -------------------------
app.post('/upload-complete', (req, res) => {
    const { paths, uploadId, totalChunks, location } = req.body;

    const relativePaths = JSON.parse(paths);
    const chunkDir = path.join(CHUNK_TEMP_DIR, uploadId);

    if (!fs.existsSync(chunkDir)) {
        return res.status(400).send("Upload session not found");
    }

    // ì €ì¥ ë  í´ë” ê²°ì •
    let baseDir;
    if (location && location.trim() !== "") {
        baseDir = path.resolve(location);
    } else if (defaultDir) {
        baseDir = path.resolve(defaultDir);
    } else {
        baseDir = path.resolve("downloads");
    }
    ensureDir(baseDir);

    // ê° íŒŒì¼ ì¡°ë¦½
    for (let relative of relativePaths) {
        const fileChunkDir = path.join(chunkDir, relative);
        const destPath = path.join(baseDir, relative);

        // í´ë” ìƒì„±
        ensureDir(path.dirname(destPath));

        // íŒŒì¼ ìƒì„±
        const writeStream = fs.createWriteStream(destPath);

        // chunk ì¡°ë¦½
        const chunkCount = parseInt(totalChunks);
        for (let i = 0; i < chunkCount; i++) {
            const chunkPath = path.join(fileChunkDir, `${i}.chunk`);
            const data = fs.readFileSync(chunkPath);
            writeStream.write(data);
        }

        writeStream.end();
    }

    // cleanup
    fs.rmSync(chunkDir, { recursive: true, force: true });

    res.status(200).send("UPLOAD_COMPLETE");
});

// -------------------------
// ì„œë²„ ì‹¤í–‰
// -------------------------
app.listen(port, host, () => {
    console.log(`í ½í³¡ Chunk File Server running at http://${host}:${port}`);
});

