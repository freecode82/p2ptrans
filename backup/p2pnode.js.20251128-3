#!/usr/bin/env node

/**
 * P2P 2.1 â€” ì™„ì „ ì–‘ë°©í–¥ ì „ì†¡ ì‹œìŠ¤í…œ
 * - ì»¨íŠ¸ë¡¤ ì„œë²„ëŠ” ì–‘ìª½ì—ì„œ í•­ìƒ ì‹¤í–‰
 * - ì–´ëŠ ë…¸ë“œì—ì„œ ëª…ë ¹ ë‚´ë¦¬ë“  Aâ†’B, Bâ†’A ì „ì†¡ ê°€ëŠ¥
 * - Race Condition ì œê±°: ë°ì´í„° ì„œë²„ Health Check + ë‹¤ìš´ë¡œë“œ ì¬ì‹œë„ added
 * - send-host / target-host êµ¬ì¡°
 */

const express = require("express");
const axios = require("axios");
const fs = require("fs");
const path = require("path");

// -------------------------------------------
// Utils
// -------------------------------------------
function fileExists(p) {
    try { fs.accessSync(p); return true; }
    catch { return false; }
}

function ensureDir(dir) {
    if (!fileExists(dir)) fs.mkdirSync(dir, { recursive: true });
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function drawProgress(downloaded, total) {
    if (!total) return;
    const ratio = downloaded / total;
    const percent = Math.floor(ratio * 100);
    const width = 40;
    const filled = Math.floor(ratio * width);
    const bar = "â–ˆ".repeat(filled) + "-".repeat(width - filled);
    process.stdout.write(`\r[${bar}] ${percent}% (${downloaded}/${total})`);
    if (downloaded === total) process.stdout.write("\n");
}

// -------------------------------------------
// CONTROL SERVER (í•­ìƒ ì¼œì ¸ ìˆìŒ)
// -------------------------------------------
async function startControlServer(port, host) {
    const app = express();
    app.use(express.json());

    console.log(`\ní ½í³¡ CONTROL SERVER RUNNING`);
    console.log(`  Host: ${host}`);
    console.log(`  Port: ${port}`);
    console.log(`  Endpoint: http://${host}:${port}/api/download-file\n`);

    // health check
    app.get("/api/health", (req, res) => {
        res.json({ status: "ok" });
    });

    /**
     * ë‹¤ìš´ë¡œë“œ ìˆ˜í–‰ API
     */
    app.post("/api/download-file", async (req, res) => {
        const { url, fileName, saveDir, progress } = req.body;

        if (!url || !fileName) {
            return res.status(400).json({ error: "url, fileName í•„ìˆ˜" });
        }

        const destDir = saveDir ? path.resolve(saveDir) : process.cwd();
        ensureDir(destDir);
        const destPath = path.join(destDir, fileName);

        console.log(`[CONTROL] ë‹¤ìš´ë¡œë“œ ìš”ì²­`);
        console.log(`  url   : ${url}`);
        console.log(`  save  : ${destPath}`);

        // ìë™ ì¬ì‹œë„ ë¡œì§ added
        const MAX_RETRY = 5;
        let attempt = 0;

        while (attempt < MAX_RETRY) {
            try {
                const resp = await axios.get(url, { responseType: "stream" });

                const total = parseInt(resp.headers["content-length"] || "0");
                let downloaded = 0;

                const ws = fs.createWriteStream(destPath);
                await new Promise((resolve, reject) => {
                    resp.data.on("data", chunk => {
                        downloaded += chunk.length;
                        if (progress && total) drawProgress(downloaded, total);
                    });
                    resp.data.on("error", reject);
                    ws.on("error", reject);
                    ws.on("finish", resolve);

                    resp.data.pipe(ws);
                });

                console.log(`\n[CONTROL] ë‹¤ìš´ë¡œë“œ ì™„ë£Œ`);
                return res.status(200).json({ status: "ok", saved: destPath });

            } catch (err) {
                console.log(`[CONTROL] ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
                attempt++;
                if (attempt >= MAX_RETRY) {
                    console.log(`[CONTROL] ì¬ì‹œë„ ëª¨ë‘ ì‹¤íŒ¨ â†’ ì „ì†¡ ì¤‘ë‹¨`);
                    return res.status(500).json({ error: err.message });
                }
                console.log(`[CONTROL] ì¬ì‹œë„ ${attempt}/${MAX_RETRY}`);
                await sleep(500);
            }
        }
    });

    app.listen(port, host);
}

// -------------------------------------------
// SEND MODE (ëª…ë ¹ì)
// -------------------------------------------
async function startSendMode(opt) {
    const {
        sourceHost,
        sourceFile,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    } = opt;

    const filePath = path.resolve(sourceFile);
    if (!fileExists(filePath)) {
        console.error("source-file not found:", filePath);
        process.exit(1);
    }

    const fileName = path.basename(filePath);
    const fileSize = fs.statSync(filePath).size;

    console.log(`\n[SEND] ì „ì†¡ ì¤€ë¹„`);
    console.log(`  ì†¡ì‹ ì(source) : ${sourceHost}`);
    console.log(`  ìˆ˜ì‹ ì(target) : ${targetHost}`);
    console.log(`  íŒŒì¼: ${filePath} (${fileSize} bytes)\n`);

    await createTempSendServer({
        filePath,
        fileName,
        sendHost: sourceHost,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    });
}

// -------------------------------------------
// TEMP DATA SERVER (ì†¡ì‹ ìì— ìƒì„±)
// + HEALTH CHECK
// -------------------------------------------
async function createTempSendServer(cfg) {
    const {
        filePath,
        fileName,
        sendHost,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    } = cfg;

    const app = express();

    // HEALTH CHECK
    app.get("/health", (req, res) => {
        res.json({ status: "ok" });
    });

    // ì‹¤ì œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì—”ë“œí¬ì¸íŠ¸
    app.get("/download", (req, res) => {
        console.log(`[DATA] ìš”ì²­ ë“¤ì–´ì˜´: /download`);

        const size = fs.statSync(filePath).size;

        res.setHeader("Content-Type", "application/octet-stream");
        res.setHeader("Content-Disposition", `attachment; filename="${fileName}"`);
        res.setHeader("Content-Length", size);

        const rs = fs.createReadStream(filePath);
        rs.on("error", err => res.destroy(err));
        rs.pipe(res);
    });

    const server = app.listen(sendPort, sendHost, async () => {
        const dataURL = `http://${sendHost}:${sendPort}`;
        console.log(`[DATA] ë°ì´í„° ì„œë²„ ON â†’ ${dataURL}`);

        // -----------------------------
        // 1) HEALTH CHECK LOOP
        // -----------------------------
        console.log(`[SEND] ë°ì´í„° ì„œë²„ ì¤€ë¹„ í™•ì¸ ì¤‘...`);
        const healthURL = `${dataURL}/health`;

        let ready = false;
        for (let i = 0; i < 60; i++) {  // ìµœëŒ€ 20íšŒ (ì•½ 2ì´ˆ)
            try {
                const r = await axios.get(healthURL, { timeout: 100 });
                if (r.data && r.data.status === "ok") {
                    ready = true;
                    break;
                }
            } catch {}
            await sleep(100);
        }

        if (!ready) {
            console.error(`[SEND] ë°ì´í„° ì„œë²„ ì¤€ë¹„ ì‹¤íŒ¨`);
            server.close();
            return;
        }

        console.log(`[SEND] ë°ì´í„° ì„œë²„ ì¤€ë¹„ ì™„ë£Œ`);

        // -----------------------------
        // 2) target-host ì— ë‹¤ìš´ë¡œë“œ ëª…ë ¹ ë³´ë‚´ê¸°
        // -----------------------------
        const controlURL = `http://${targetHost}:${targetPort}/api/download-file`;

        try {
            const resp = await axios.post(controlURL, {
                url: `http://${sendHost}:${sendPort}/download`,
                fileName,
                saveDir: targetSave,
                progress
            }, { timeout: 0 });

            console.log(`[SEND] ìƒëŒ€ ì‘ë‹µ:`, resp.data);

        } catch (err) {
            console.error(`[SEND] ë‹¤ìš´ë¡œë“œ ëª…ë ¹ ì‹¤íŒ¨: ${err.message}`);
        }

        console.log(`[DATA] ë°ì´í„° ì„œë²„ ì¢…ë£Œ`);
        server.close();
    });
}

// -------------------------------------------
// CLI Parser
// -------------------------------------------
function parseArgs(argv) {
    const out = {};
    for (let i = 0; i < argv.length; i++) {
        const arg = argv[i];
        if (arg.startsWith("--")) {
            const key = arg.slice(2);
            const next = argv[i + 1];
            if (!next || next.startsWith("-")) out[key] = true;
            else { out[key] = next; i++; }
        } else if (arg.startsWith("-")) {
            const key = arg.slice(1);
            const next = argv[i + 1];
            if (!next || next.startsWith("-")) out[key] = true;
            else { out[key] = next; i++; }
        }
    }
    return out;
}

// -------------------------------------------
// ENTRY POINT
// -------------------------------------------
(async () => {
    const args = parseArgs(process.argv.slice(2));

    // Control server
    if (args.control) {
        const host = args.h || args.host || "0.0.0.0";
        const port = parseInt(args.p || args.port || 7000);
        await startControlServer(port, host);
        return;
    }

    // Send mode
    if (args.send) {
        const sourceHost = args["source-host"] || args["send-host"] || "127.0.0.1";
        const sendPort   = parseInt(args["send-port"] || 9000);
        const sourceFile = args["source-file"] || args.f;

        const targetHost = args["target-host"] || args["client-host"];
        const targetPort = parseInt(args["target-port"] || args["client-port"] || 7000);
        const targetSave = args["target-save"] || args["client-save"];
        const progress   = args.b || args.progress;

        if (!sourceFile) {
            console.error("Error: --source-file <file> required");
            process.exit(1);
        }
        if (!targetHost) {
            console.error("Error: --target-host <IP> required");
            process.exit(1);
        }

        await startSendMode({
            sourceHost,
            sourceFile,
            sendPort,
            targetHost,
            targetPort,
            targetSave,
            progress
        });
        return;
    }

    // Usage
    console.log(`
ì‚¬ìš©ë²•:

## CONTROL SERVER (ì–‘ìª½ì—ì„œ í•­ìƒ ì‹¤í–‰)
node p2pnode.js --control -p 7000 -h 0.0.0.0

## ANY NODE â†’ SEND COMMAND (ì „ì†¡ ë°©í–¥ ììœ )
node p2pnode.js --send \\
    --source-host 192.168.79.9 \\
    --source-file /root/a.bin \\
    --send-port 9000 \\
    --target-host 192.168.146.131 \\
    --target-port 7000 \\
    --target-save /root/downloads \\
    -b
    `);
})();

