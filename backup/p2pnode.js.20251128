#!/usr/bin/env node

const express = require('express');
const fs = require('fs');
const path = require('path');
const axios = require('axios');

// -------------------------
// ê³µìš© ìœ í‹¸
// -------------------------
function fileExists(p) {
    try {
        fs.accessSync(p, fs.constants.F_OK);
        return true;
    } catch {
        return false;
    }
}

function ensureDir(dirPath) {
    if (!fileExists(dirPath)) {
        fs.mkdirSync(dirPath, { recursive: true });
    }
}

// ê°„ë‹¨í•œ progress bar (ì˜µì…˜ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆê²Œ ë§Œë“¤ì–´ ë‘ )
function drawProgressBar(downloaded, total) {
    if (!total || total <= 0) return;
    const ratio = downloaded / total;
    const percent = Math.floor(ratio * 100);
    const width = 40;
    const filled = Math.floor(width * ratio);
    const bar = 'â–ˆ'.repeat(filled) + '-'.repeat(width - filled);
    process.stdout.write(`\r[${bar}] ${percent}% (${downloaded}/${total} bytes)`);
    if (downloaded >= total) {
        process.stdout.write('\n');
    }
}

// -------------------------
// ì»¨íŠ¸ë¡¤ ì„œë²„ ëª¨ë“œ
// -------------------------
async function startControlServer(port, host) {
    const app = express();
    app.use(express.json());

    // í—¬ìŠ¤ ì²´í¬
    app.get('/api/health', (req, res) => {
        res.json({ status: 'ok' });
    });

    /**
     * POST /api/download-file
     * {
     *   "url": "http://SENDER_IP:PORT/download",
     *   "fileName": "abc.bin",
     *   "saveDir": "/path/to/save",
     *   "showProgress": true  // optional
     * }
     */
    app.post('/api/download-file', async (req, res) => {
        const { url, fileName, saveDir, showProgress } = req.body || {};
        if (!url || !fileName) {
            return res.status(400).json({ error: 'url, fileName í•„ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.' });
        }

        const dir = saveDir ? path.resolve(saveDir) : process.cwd();
        ensureDir(dir);
        const destPath = path.join(dir, fileName);

        console.log(`\n[CONTROL] íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ ë°›ìŒ`);
        console.log(`  - URL      : ${url}`);
        console.log(`  - ì €ì¥ ìœ„ì¹˜: ${destPath}`);

        try {
            const resp = await axios.get(url, { responseType: 'stream' });

            const total = parseInt(resp.headers['content-length'] || '0', 10);
            if (total) console.log(`  - í¬ê¸°: ${total} bytes`);

            let downloaded = 0;
            const ws = fs.createWriteStream(destPath);

            await new Promise((resolve, reject) => {
                resp.data.on('data', (chunk) => {
                    downloaded += chunk.length;
                    if (showProgress && total) {
                        drawProgressBar(downloaded, total);
                    }
                });
                resp.data.on('error', reject);
                ws.on('error', reject);
                ws.on('finish', resolve);

                resp.data.pipe(ws);
            });

            console.log(`\n[CONTROL] ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${destPath}`);
            return res.status(200).json({ status: 'ok', path: destPath });

        } catch (err) {
            console.error(`[CONTROL] ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
            return res.status(500).json({ error: err.message });
        }
    });

    app.listen(port, host, () => {
        console.log(`í ½í³¡ ì»¨íŠ¸ë¡¤ ì„œë²„ ì‹¤í–‰ ì¤‘`);
        console.log(`  - Host: ${host}`);
        console.log(`  - Port: ${port}`);
        console.log(`  - API : http://${host}:${port}/api/download-file`);
    });
}

// -------------------------
// SEND ëª¨ë“œ (ë‚´ê°€ ë³´ë‚´ëŠ” ìª½)
// -------------------------
async function startSendMode(options) {
    const {
        filePath,
        localHost,
        dataPort,
        remoteHost,
        remotePort,
        remoteSaveDir,
        showProgress
    } = options;

    const resolvedFile = path.resolve(filePath);
    if (!fileExists(resolvedFile)) {
        console.error(`Error: ë³´ë‚¼ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ â†’ ${resolvedFile}`);
        process.exit(1);
    }

    const stat = fs.statSync(resolvedFile);
    if (!stat.isFile()) {
        console.error(`í˜„ì¬ ì˜ˆì œëŠ” "íŒŒì¼"ë§Œ ì „ì†¡í•©ë‹ˆë‹¤. í´ë” ì „ì†¡ì€ tar/gzip ë“± ì¶”ê°€ ì„¤ê³„ê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
        process.exit(1);
    }

    const fileName = path.basename(resolvedFile);

    // 1) ì„ì‹œ ë°ì´í„° ì„œë²„ ë„ìš°ê¸°
    const app = express();

    app.get('/download', (req, res) => {
        console.log(`[DATA] /download ìš”ì²­ ë“¤ì–´ì˜´, íŒŒì¼ ì „ì†¡ ì‹œì‘: ${resolvedFile}`);
        res.setHeader('Content-Type', 'application/octet-stream');
        res.setHeader('Content-Disposition', `attachment; filename="${fileName}"`);
        res.setHeader('Content-Length', stat.size);

        const rs = fs.createReadStream(resolvedFile);
        rs.on('error', (err) => {
            console.error('[DATA] ReadStream Error:', err.message);
            res.destroy(err);
        });
        rs.pipe(res);
    });

    const server = app.listen(dataPort, localHost, async () => {
        const dataUrl = `http://${localHost}:${dataPort}/download`;
        console.log(`\n[DATA] ì„ì‹œ ë°ì´í„° ì„œë²„ ì‹¤í–‰ ì¤‘`);
        console.log(`  - URL      : ${dataUrl}`);
        console.log(`  - FilePath : ${resolvedFile}`);
        console.log(`  - Size     : ${stat.size} bytes`);

        // 2) ìƒëŒ€ ì»¨íŠ¸ë¡¤ ì„œë²„ì— REST ìš”ì²­ ë³´ë‚´ì„œ ë‹¤ìš´ë¡œë“œ ì‹œì‘ì‹œí‚¤ê¸°
        const controlUrl = `http://${remoteHost}:${remotePort}/api/download-file`;
        console.log(`\n[CONTROL-CLIENT] ìƒëŒ€ ì»¨íŠ¸ë¡¤ ì„œë²„ í˜¸ì¶œ`);
        console.log(`  - URL: ${controlUrl}`);

        try {
            const resp = await axios.post(controlUrl, {
                url: dataUrl,
                fileName,
                saveDir: remoteSaveDir,
                showProgress: !!showProgress
            }, {
                timeout: 0   // í° íŒŒì¼ë„ ëê¹Œì§€ ê¸°ë‹¤ë¦¬ë„ë¡
            });

            console.log(`\n[CONTROL-CLIENT] ìƒëŒ€ ì‘ë‹µ:`, resp.status, resp.data);

        } catch (err) {
            console.error(`\n[CONTROL-CLIENT] í˜¸ì¶œ ì‹¤íŒ¨: ${err.message}`);
        } finally {
            // 3) ì „ì†¡ ëë‚¬ìœ¼ë‹ˆ ë°ì´í„° ì„œë²„ ì¢…ë£Œ
            console.log(`\n[DATA] ì„ì‹œ ë°ì´í„° ì„œë²„ ì¢…ë£Œ`);
            server.close();
        }
    });
}

// -------------------------
// CLI íŒŒì‹±
// -------------------------
function parseArgs(argv) {
    const out = { _: [] };
    for (let i = 0; i < argv.length; i++) {
        const a = argv[i];
        if (a.startsWith('--')) {
            const key = a.slice(2);
            const next = argv[i + 1];
            if (!next || next.startsWith('-')) {
                out[key] = true;
            } else {
                out[key] = next;
                i++;
            }
        } else if (a.startsWith('-')) {
            const key = a.slice(1);
            const next = argv[i + 1];
            if (!next || next.startsWith('-')) {
                out[key] = true;
            } else {
                out[key] = next;
                i++;
            }
        } else {
            out._.push(a);
        }
    }
    return out;
}

// -------------------------
// ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸
// -------------------------
(async () => {
    const argv = parseArgs(process.argv.slice(2));

    const isControl = argv.control || argv['control'] === '' || argv['--control'];
    const isSend    = argv.send    || argv['send'] === ''    || argv['--send'];

    if (isControl) {
        const port = argv.p ? parseInt(argv.p, 10) : (argv.port ? parseInt(argv.port, 10) : 7000);
        const host = argv.h || argv.host || '0.0.0.0';
        await startControlServer(port, host);
        return;
    }

    if (isSend) {
        const filePath = argv.f || argv.file;
        if (!filePath) {
            console.error('Error: --send ëª¨ë“œì—ì„œëŠ” -f <ë³´ë‚¼ íŒŒì¼ ê²½ë¡œ> ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            process.exit(1);
        }

        const localHost = argv['local-host'] || argv.lh || '0.0.0.0';
        const dataPort  = argv['data-port']  || argv.dp || 9000;

        const remoteHost = argv['remote-host'] || argv.rh;
        const remotePort = argv['remote-port'] || argv.rp || 7000;
        const remoteSaveDir = argv['remote-save'] || argv.rs || null;

        if (!remoteHost) {
            console.error('Error: --send ëª¨ë“œì—ì„œëŠ” --remote-host (ë˜ëŠ” -rh) ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            process.exit(1);
        }

        const showProgress = !!(argv.b || argv['progress']);

        await startSendMode({
            filePath,
            localHost,
            dataPort: parseInt(dataPort, 10),
            remoteHost,
            remotePort: parseInt(remotePort, 10),
            remoteSaveDir,
            showProgress
        });
        return;
    }

    // ì‚¬ìš©ë²• ì¶œë ¥
    console.log(`
ì‚¬ìš©ë²•:

1) ì»¨íŠ¸ë¡¤ ì„œë²„ ì‹¤í–‰ (ê° ë…¸ë“œì—ì„œ 1ë²ˆì”© ë„ì›Œë‘ê¸°)
   node p2pnode.js --control -p 7000 -h 0.0.0.0

2) A â†’ B ë¡œ íŒŒì¼ ë³´ë‚´ê¸° (Aì—ì„œ ì‹¤í–‰)
   node p2pnode.js --send \\
       -f /path/to/file \\
       --local-host A_IP \\
       --data-port 9000 \\
       --remote-host B_IP \\
       --remote-port 7000 \\
       --remote-save /remote/save/dir \\
       -b

ì˜µì…˜ ìš”ì•½:
  --control, -control       ì»¨íŠ¸ë¡¤ ì„œë²„ ëª¨ë“œ
    -p, --port              ì»¨íŠ¸ë¡¤ ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 7000)
    -h, --host              ë°”ì¸ë”©í•  IP (ê¸°ë³¸ 0.0.0.0)

  --send                    íŒŒì¼ ë³´ë‚´ê¸° ëª¨ë“œ
    -f, --file              ë³´ë‚¼ íŒŒì¼ ê²½ë¡œ
    --local-host, -lh       ì„ì‹œ ë°ì´í„° ì„œë²„ì—ì„œ ì‚¬ìš©í•  ë‚´ IP (ìƒëŒ€ê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ IP)
    --data-port,  -dp       ì„ì‹œ ë°ì´í„° ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 9000)
    --remote-host, -rh      ìƒëŒ€ ì»¨íŠ¸ë¡¤ ì„œë²„ IP
    --remote-port, -rp      ìƒëŒ€ ì»¨íŠ¸ë¡¤ ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 7000)
    --remote-save, -rs      ìƒëŒ€ ìª½ì—ì„œ ì €ì¥í•  ë””ë ‰í„°ë¦¬ (ì—†ìœ¼ë©´ ìƒëŒ€ current dir)
    -b, --progress          ìƒëŒ€ ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  í‘œì‹œ

ì˜ˆì‹œ:

  # ê° ë…¸ë“œì—ì„œ ì»¨íŠ¸ë¡¤ ì„œë²„ ì‹¤í–‰
  node p2pnode.js --control -p 7000 -h 0.0.0.0

  # A(10.0.0.10) â†’ B(10.0.0.20) ë¡œ íŒŒì¼ ë³´ë‚´ê¸°
  node p2pnode.js --send \\
      -f /root/test.jar \\
      --local-host 10.0.0.10 \\
      --data-port 9000 \\
      --remote-host 10.0.0.20 \\
      --remote-port 7000 \\
      --remote-save /root/downloads \\
      -b
`);
})();

