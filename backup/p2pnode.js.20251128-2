#!/usr/bin/env node

/**
 * P2P 2.0 íŒŒì¼ ì „ì†¡ ì‹œìŠ¤í…œ
 * - ì–‘ìª½ ë…¸ë“œì—ì„œ ì»¨íŠ¸ë¡¤ ì„œë²„ëŠ” í•­ìƒ ì‹¤í–‰
 * - ì–´ëŠ ë…¸ë“œì—ì„œ ëª…ë ¹ì„ ë‚´ë ¤ë„ Aâ†’B / Bâ†’A ììœ  ì „ì†¡
 * - ì—…ë¡œë“œ(body-limit ë¬¸ì œ) ì—†ìŒ. í•­ìƒ "ë‹¤ìš´ë¡œë“œ ë°©í–¥" ì „ì†¡.
 *
 * ì—­í•  ìš”ì•½:
 *  1) Control Server  (í•­ìƒ ì¼œì§)  â†’ /api/download-file
 *  2) Send Orchestrator (--send) â†’ source / target ì§€ì •
 *  3) Source Host  (íŒŒì¼ ê°€ì§„ ìª½) â†’ ì„ì‹œ ì „ì†¡ ì„œë²„ /download ì œê³µ
 *  4) Target Host (íŒŒì¼ ë°›ì„ ìª½) â†’ Control APIë¡œ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
 */

const express = require("express");
const axios = require("axios");
const fs = require("fs");
const path = require("path");

// -------------------- ê³µìš© ìœ í‹¸ --------------------
function fileExists(p) {
    try { fs.accessSync(p); return true; }
    catch { return false; }
}

function ensureDir(dir) {
    if (!fileExists(dir)) {
        fs.mkdirSync(dir, { recursive: true });
    }
}

// progress bar (ì„ íƒ)
function drawProgress(downloaded, total) {
    if (!total) return;
    const w = 40;
    const ratio = downloaded / total;
    const bar = Math.floor(ratio * w);
    process.stdout.write(
        `\r[${"â–ˆ".repeat(bar)}${"-".repeat(w - bar)}] ${Math.floor(ratio * 100)}%`
    );
    if (downloaded === total) process.stdout.write("\n");
}

// -------------------- CONTROL ì„œë²„ --------------------
async function startControlServer(port, host) {
    const app = express();
    app.use(express.json());

    console.log(`\ní ½í³¡ CONTROL SERVER RUNNING`);
    console.log(`  Host: ${host}`);
    console.log(`  Port: ${port}`);
    console.log(`  Endpoint: http://${host}:${port}/api/download-file\n`);

    // health check
    app.get("/api/health", (req, res) => {
        res.json({ status: "ok" });
    });

    /**
     * POST /api/download-file
     * {
     *   url: "http://A:9000/download",
     *   fileName: "a.bin",
     *   saveDir: "/root/recv",
     *   progress: true
     * }
     */
    app.post("/api/download-file", async (req, res) => {
        const { url, fileName, saveDir, progress } = req.body;

        if (!url || !fileName) {
            return res.status(400).json({ error: "url, fileName ì€ í•„ìˆ˜ì…ë‹ˆë‹¤." });
        }

        const destDir = saveDir ? path.resolve(saveDir) : process.cwd();
        ensureDir(destDir);

        const destPath = path.join(destDir, fileName);

        console.log(`\n[CONTROL] ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì ‘ìˆ˜`);
        console.log(`  URL  : ${url}`);
        console.log(`  Dest : ${destPath}`);

        try {
            const resp = await axios.get(url, { responseType: "stream" });

            const total = parseInt(resp.headers["content-length"] || "0");
            const ws = fs.createWriteStream(destPath);

            let downloaded = 0;

            await new Promise((resolve, reject) => {
                resp.data.on("data", chunk => {
                    downloaded += chunk.length;
                    if (progress && total) drawProgress(downloaded, total);
                });
                resp.data.on("error", reject);
                ws.on("error", reject);
                ws.on("finish", resolve);

                resp.data.pipe(ws);
            });

            console.log(`\n[CONTROL] ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${destPath}`);
            return res.status(200).json({ status: "ok", saved: destPath });

        } catch (err) {
            console.error(`[CONTROL] ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
            return res.status(500).json({ error: err.message });
        }
    });

    app.listen(port, host);
}

// -------------------- SEND ëª¨ë“œ (ëª…ë ¹ì) --------------------
async function startSendMode(opt) {
    const {
        sourceHost,
        sourceFile,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    } = opt;

    const filePath = path.resolve(sourceFile);
    if (!fileExists(filePath)) {
        console.error("Error: source-file ê²½ë¡œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ â†’ " + filePath);
        process.exit(1);
    }

    const fileName = path.basename(filePath);
    const fileSize = fs.statSync(filePath).size;

    console.log(`\n[SEND] íŒŒì¼ ì „ì†¡ ì¤€ë¹„`);
    console.log(`  source-host : ${sourceHost}`);
    console.log(`  target-host : ${targetHost}`);
    console.log(`  file        : ${filePath} (${fileSize} bytes)`);
    console.log(`  save        : ${targetSave || "(target current dir)"}`);
    console.log("");

    // STEP 1 â€” sourceHostì— "ì „ì†¡ ì„œë²„ ì‹œì‘" RPC ìš”ì²­
    const startUrl = `http://${sourceHost}:${targetPort}/api/start-data-server`;
    // BUT ì•„ì§ ì´ëŸ° API ì—†ìŒ â†’ ì‹¤ì œë¡œëŠ” sourceHostê°€ SEND ëª…ë ¹ìì„.

    // ì—¬ê¸°ì—ì„œëŠ” sendHostê°€ â€œëª…ë ¹ìâ€ì™€ ë™ì¼ ë…¸ë“œë¼ê³  ê°€ì •í–ˆìœ¼ë¯€ë¡œ
    // SEND ëª…ë ¹ìëŠ” ì§ì ‘ ì„ì‹œ ì „ì†¡ ì„œë²„ë¥¼ ë„ìš´ë‹¤.

    await createTempSendServer({
        filePath,
        fileName,
        sendHost: sourceHost,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    });
}

// -------------------- TEMP DATA SERVER (ì†¡ì‹ ì) --------------------
async function createTempSendServer(cfg) {
    const {
        filePath,
        fileName,
        sendHost,
        sendPort,
        targetHost,
        targetPort,
        targetSave,
        progress
    } = cfg;

    const app = express();

    // /download ì œê³µ
    app.get("/download", (req, res) => {
        console.log(`[DATA] /download ìš”ì²­ â†’ íŒŒì¼ ì „ì†¡ ì‹œì‘`);
        const size = fs.statSync(filePath).size;

        res.setHeader("Content-Type", "application/octet-stream");
        res.setHeader("Content-Disposition", `attachment; filename="${fileName}"`);
        res.setHeader("Content-Length", size);

        const rs = fs.createReadStream(filePath);
        rs.on("error", err => {
            console.error("[DATA] ReadStream error:", err);
            res.destroy(err);
        });
        rs.pipe(res);
    });

    // ì„œë²„ ì‹œì‘
    const server = app.listen(sendPort, sendHost, async () => {
        console.log(`[DATA] ì„ì‹œ ë°ì´í„° ì„œë²„ ON â†’ http://${sendHost}:${sendPort}/download`);

        // STEP 2 â€” target-host ì»¨íŠ¸ë¡¤ ì„œë²„ì— â€œë‹¤ìš´ë¡œë“œ ì‹œì‘â€ ìš”ì²­
        const controlUrl = `http://${targetHost}:${targetPort}/api/download-file`;

        try {
            const resp = await axios.post(controlUrl, {
                url: `http://${sendHost}:${sendPort}/download`,
                fileName,
                saveDir: targetSave,
                progress: !!progress
            }, { timeout: 0 });

            console.log(`[SEND] ìƒëŒ€ ì‘ë‹µ:`, resp.data);

        } catch (err) {
            console.error(`[SEND] ìƒëŒ€ ë‹¤ìš´ë¡œë“œ ìš”ì²­ ì‹¤íŒ¨: ${err.message}`);
        }

        console.log(`[DATA] ì„ì‹œ ë°ì´í„° ì„œë²„ ì¢…ë£Œ`);
        server.close();
    });
}

// -------------------- CLI íŒŒì„œ --------------------
function parseArgs(argv) {
    const out = {};
    for (let i = 0; i < argv.length; i++) {
        const a = argv[i];
        if (a.startsWith("--")) {
            const key = a.slice(2);
            const next = argv[i + 1];
            if (!next || next.startsWith("-")) {
                out[key] = true;
            } else {
                out[key] = next;
                i++;
            }
        } else if (a.startsWith("-")) {
            const key = a.slice(1);
            const next = argv[i + 1];
            if (!next || next.startsWith("-")) {
                out[key] = true;
            } else {
                out[key] = next;
                i++;
            }
        }
    }
    return out;
}

// -------------------- MAIN --------------------
(async () => {
    const args = parseArgs(process.argv.slice(2));

    // CONTROL ëª¨ë“œ
    if (args.control) {
        const host = args.h || args.host || "0.0.0.0";
        const port = args.p || args.port || 7000;
        await startControlServer(parseInt(port), host);
        return;
    }

    // SEND ëª¨ë“œ
    if (args.send) {
        const sourceHost  = args["source-host"] || args["send-host"] || "127.0.0.1";
        const sendPort    = parseInt(args["send-port"] || 9000);
        const sourceFile  = args["source-file"] || args.f;

        const targetHost  = args["target-host"] || args["client-host"] || null;
        const targetPort  = parseInt(args["target-port"] || args["client-port"] || 7000);
        const targetSave  = args["target-save"] || args["client-save"] || null;

        const progress    = args.b || args.progress || false;

        if (!sourceFile) {
            console.error("Error: --source-file <íŒŒì¼> ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            process.exit(1);
        }
        if (!targetHost) {
            console.error("Error: --target-host <IP> ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
            process.exit(1);
        }

        await startSendMode({
            sourceHost,
            sourceFile,
            sendPort,
            targetHost,
            targetPort,
            targetSave,
            progress
        });
        return;
    }

    console.log(`
ì‚¬ìš©ë²•:

1) ì»¨íŠ¸ë¡¤ ì„œë²„ ì‹¤í–‰ (ì–‘ ë…¸ë“œ ëª¨ë‘ì—ì„œ):
   node p2pnode.js --control -p 7000 -h 0.0.0.0

2) ì•„ë¬´ìª½ì—ì„œë‚˜ ì „ì†¡ ëª…ë ¹:
   node p2pnode.js --send \\
       --source-host 10.0.0.10 \\
       --source-file /root/a.bin \\
       --send-port 9000 \\
       --target-host 10.0.0.20 \\
       --target-port 7000 \\
       --target-save /root/downloads \\
       -b

ì˜µì…˜ ìš”ì•½:

--control         ì»¨íŠ¸ë¡¤ ì„œë²„
  -p              í¬íŠ¸ (ê¸°ë³¸ 7000)
  -h              í˜¸ìŠ¤íŠ¸(default 0.0.0.0)

--send            íŒŒì¼ ì „ì†¡ ëª…ë ¹ì
  --source-host   íŒŒì¼ì„ ê°€ì§„ ë…¸ë“œ IP
  --source-file   ë³´ë‚¼ íŒŒì¼
  --send-port     ì„ì‹œ ë°ì´í„° ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 9000)

  --target-host   íŒŒì¼ ë°›ì„ ë…¸ë“œ IP
  --target-port   ê·¸ ë…¸ë“œì˜ ì»¨íŠ¸ë¡¤ ì„œë²„ í¬íŠ¸(ê¸°ë³¸ 7000)
  --target-save   ì €ì¥ ê²½ë¡œ

  -b, --progress  ì§„í–‰ë¥  í‘œì‹œ
`);
})();

