#!/usr/bin/env node

const express = require('express');
const multer = require('multer');
const fs = require('fs');
const path = require('path');

// ì˜µì…˜ íŒŒì‹±
const args = process.argv.slice(2);
const pIndex = args.indexOf('-p');
const hIndex = args.indexOf('-h');
const fIndex = args.indexOf('-f');

const port = pIndex !== -1 ? parseInt(args[pIndex + 1]) : 80;
const host = hIndex !== -1 ? args[hIndex + 1] : 'localhost';
const defaultDir = fIndex !== -1 ? args[fIndex + 1] : null;

const app = express();
app.use(express.json());
app.use(express.urlencoded({extended: true}));

// multer â€” temp ì €ìž¥ê³µê°„
const upload = multer({ dest: "temp/" });

// í´ë” ìƒì„± í•¨ìˆ˜
function ensureDir(dirPath) {
    if (!fs.existsSync(dirPath)) {
        fs.mkdirSync(dirPath, { recursive: true });
    }
}

app.post('/upload', upload.any(), (req, res) => {
    const location = req.body.location;
    const files = req.files;
    const paths = JSON.parse(req.body.paths);   // â† clientê°€ ë³´ë‚¸ ìƒëŒ€ê²½ë¡œ ë°°ì—´

    if (!files || files.length === 0 || !paths) {
        return res.status(400).send("Invalid upload");
    }

    let baseDir;

    // ì €ìž¥ ìœ„ì¹˜ ê²°ì •
    if (location && location.trim() !== "") {
        baseDir = path.resolve(location);
    } else if (defaultDir) {
        baseDir = path.resolve(defaultDir);
    } else {
        baseDir = path.resolve("downloads");
    }

    ensureDir(baseDir);

    // íŒŒì¼ ì €ìž¥
    files.forEach((file, i) => {
        const relativePath = paths[i];                 // í´ë” í¬í•¨ ê²½ë¡œ
        const destPath = path.join(baseDir, relativePath);

        ensureDir(path.dirname(destPath));

        fs.renameSync(file.path, destPath);
    });

    res.status(200).send("OK");
});

// ì„œë²„ ì‹¤í–‰
app.listen(port, host, () => {
    console.log(`í ½í³¡ Server running at http://${host}:${port}`);
});

